# Salt Open Apache Deployment

This directory contains a Salt Open implementation for deploying Apache web server in masterless mode.

## Overview

Salt Open (also known as SaltStack) is a configuration management and remote execution tool. This implementation uses Salt in "masterless" mode (salt-call --local) to configure systems without requiring a Salt master server.

## Directory Structure

```
salt/
├── states/          # Salt state files (equivalent to Chef cookbooks)
│   └── apache/
│       ├── init.sls              # Main Apache state file
│       └── files/
│           └── index.html.jinja  # Jinja2 template for Apache index page
├── pillar/          # Salt pillar data (configuration data)
│   ├── top.sls      # Pillar top file (assigns pillar data to minions)
│   └── apache.sls   # Apache-specific pillar data
├── config/          # Salt configuration
│   └── minion       # Minion configuration for masterless mode
├── scripts/         # Installation scripts (generated by build.sh)
├── output/          # Build output directory (generated)
├── build.sh         # Build script to create deployment package
├── test-deployment.sh  # Docker-based test script
└── stop-containers.sh  # Stop test containers
```

## Prerequisites

- Ubuntu 24.04 Linux (target system)
- Docker (for testing with test-deployment.sh)
- Internet connection (for package installation)

## Building

Run the build script to create the deployment package:

```bash
./build.sh
```

This creates:
- `output/salt-runtime.tar.gz` - Salt states and configuration
- `output/install.sh` - Installation script
- `output/post-install.sh` - Post-installation script (applies states)
- `output/uninstall.sh` - Uninstallation script

## Installation

1. Copy all files from `output/` to the target Ubuntu 24.04 machine
2. Set the INSTALLER_PATH environment variable and run install.sh:
   ```bash
   export INSTALLER_PATH=/path/to/installer
   sudo INSTALLER_PATH=$INSTALLER_PATH ./install.sh
   ```
3. Apply Salt states:
   ```bash
   sudo INSTALLER_PATH=$INSTALLER_PATH ./post-install.sh
   ```

## Testing

Test the deployment in a Docker container:

```bash
./test-deployment.sh
```

This will:
1. Start an Ubuntu 24.04 container
2. Install Salt in masterless mode
3. Apply Salt states to install Apache
4. Verify Apache is running
5. Clean up and uninstall

Stop any running test containers:
```bash
./stop-containers.sh
```

## How It Works

### Salt States
Salt states are declarative configurations that describe the desired state of a system. The main Apache state (`states/apache/init.sls`) handles:
- Creating www-data user/group
- Installing Apache package
- Configuring Apache
- Deploying custom index.html
- Starting Apache service

### Pillar Data
Pillar is Salt's system for managing configuration data. The Apache pillar (`pillar/apache.sls`) contains:
- Server configuration
- Variable values for templates

### Masterless Mode
This implementation uses Salt in masterless mode:
- No Salt master server required
- States are applied locally using `salt-call --local`
- Configuration in `/etc/salt/minion` points to local file paths

### Templates
Salt uses Jinja2 templates for dynamic content. The index.html template can access:
- Grains (system information)
- Pillar data
- Environment variables

## Environment Variables

The following environment variables can be passed:
- `FLEET_SECRET_VAR1` - Passed to the index.html template

Example:
```bash
sudo FLEET_SECRET_VAR1="my-secret" ./post-install.sh
```

## Comparison with Other Tools

| Feature | Salt | Chef | Puppet | Ansible |
|---------|------|------|--------|---------|
| Language | YAML/Python | Ruby DSL | Puppet DSL | YAML |
| Agent | Optional | Required | Required | Agentless |
| Masterless | Yes | Yes (local mode) | Yes (apply) | Default |
| Templates | Jinja2 | ERB | EPP | Jinja2 |
| Architecture | Master-Minion or Masterless | Client-Server or Solo | Master-Agent or Apply | Push-based |

## Troubleshooting

### Check Salt version
```bash
salt-call --version
```

### Test pillar data
```bash
salt-call --local pillar.items
```

### Apply states with verbose output
```bash
salt-call --local state.apply -l debug
```

### Check Apache status
```bash
systemctl status apache2
```

### View Salt logs
```bash
tail -f /var/log/salt/minion
```

## Uninstallation

To remove Apache and Salt runtime:
```bash
sudo ./uninstall.sh
```

Note: The Salt minion package itself remains installed but the runtime and states are removed.